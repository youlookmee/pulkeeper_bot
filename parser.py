# parser.py
import re
from datetime import datetime


# üî• –≥–æ—Ç–æ–≤—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–º–æ–∂–µ–º —Ä–∞—Å—à–∏—Ä—è—Ç—å –ø–æ—Ç–æ–º)
CATEGORY_KEYWORDS = {
    "–µ–¥–∞": ["–µ–¥–∞", "–æ–±–µ–¥", "–∑–∞–≤—Ç—Ä–∞–∫", "—É–∂–∏–Ω", "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç", "–ø–∏—Ü—Ü–∞", "–±—É—Ä–≥–µ—Ä"],
    "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç": ["—Ç–∞–∫—Å–∏", "–∞–≤—Ç–æ", "–º–∞—à–∏–Ω–∞", "–±–µ–Ω–∑–∏–Ω", "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "metro", "bus"],
    "–ø—Ä–æ–¥—É–∫—Ç—ã": ["–ø—Ä–æ–¥—É–∫—Ç—ã", "–º–∞–≥–∞–∑–∏–Ω", "–∫–∞—Ä–∑–∏–Ω–∫–∞", "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "–º–∏–Ω–∏–º–∞—Ä–∫–µ—Ç"],
    "–∑–¥–æ—Ä–æ–≤—å–µ": ["–∞–ø—Ç–µ–∫–∞", "–ª–µ–∫–∞—Ä", "–º–µ–¥–∏—Ü–∏–Ω–∞"],
    "–æ–¥–µ–∂–¥–∞": ["–æ–¥–µ–∂–¥–∞", "—à–º–æ—Ç", "–±–æ—Ç–∏–Ω–∫–∏", "—Ñ—É—Ç–±–æ–ª–∫–∞", "–∫—Ä–æ—Å—Å–æ–≤–∫–∏"],
    "–∫—Ä–∞—Å–æ—Ç–∞": ["—Å–∞–ª–æ–Ω", "–±–∞—Ä–±–µ—Ä", "—Å—Ç—Ä–∏–∂–∫–∞", "–º–∞–Ω–∏–∫—é—Ä"],
    "–¥–æ–º": ["–∫–æ–º—É–Ω–∞–ª–∫–∞", "—Å–≤–µ—Ç", "–≥–∞–∑", "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç"],
    "–∑–∞—Ä–ø–ª–∞—Ç–∞": ["–∑–∞—Ä–ø–ª–∞—Ç–∞", "–¥–æ—Ö–æ–¥", "–ø–æ–ª—É—á–∏–ª", "–ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "–∞–≤–∞–Ω—Å"],
    "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è": ["–∫–∏–Ω–æ", "—Ñ–∏–ª—å–º", "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è", "–∏–≥—Ä–∞", "—Ç–µ–∞—Ç—Ä"],
}


# ---------------------------------------------
# 1. –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –°–£–ú–ú–´
# ---------------------------------------------
def extract_amount(text: str):
    text = text.lower()

    # –ü—Ä–∏–º–µ—Ä: 30k / 50–∫
    k_match = re.search(r"(\d+)\s*[k–∫]", text)
    if k_match:
        return float(k_match.group(1)) * 1000

    # –ü—Ä–∏–º–µ—Ä: 1.5 –º–ª–Ω
    mln_match = re.search(r"(\d+(?:[\.,]\d+)?)\s*–º–ª–Ω", text)
    if mln_match:
        return float(mln_match.group(1).replace(",", ".")) * 1_000_000

    # –û–±—ã—á–Ω—ã–µ —á–∏—Å–ª–∞ (44.000 / 44 000 / 44000)
    normal = re.findall(r"\d[\d\s\.,]*", text)
    if normal:
        num = normal[0].replace(" ", "").replace(",", "").replace(".", "")
        return float(num)

    return None


# ---------------------------------------------
# 2. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –¢–ò–ü–ê (–¥–æ—Ö–æ–¥/—Ä–∞—Å—Ö–æ–¥)
# ---------------------------------------------
def detect_type(text: str):
    text = text.lower()

    income_words = ["–∑–∞—Ä–ø–ª–∞—Ç–∞", "–ø–æ–ª—É—á–∏–ª", "–ø–æ—Å—Ç—É–ø–∏–ª–æ", "–∞–≤–∞–Ω—Å", "–¥–æ—Ö–æ–¥", "–ø—Ä–∏–±—ã–ª—å"]
    if any(w in text for w in income_words):
        return "income"

    return "expense"


# ---------------------------------------------
# 3. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ò
# ---------------------------------------------
def detect_category(text: str):
    text = text.lower()
    for cat, keywords in CATEGORY_KEYWORDS.items():
        if any(w in text for w in keywords):
            return cat
    return "–ø—Ä–æ—á–µ–µ"


# ---------------------------------------------
# 4. –ü–û–õ–ù–´–ô –ü–ê–†–°–ò–ù–ì –¢–†–ê–ù–ó–ê–ö–¶–ò–ò
# ---------------------------------------------
def parse_transaction(text: str):
    amount = extract_amount(text)
    if not amount:
        return None

    tx_type = detect_type(text)
    category = detect_category(text)

    return {
        "amount": amount,
        "type": tx_type,
        "category": category,
        "description": text,
        "date": datetime.now().date()
    }
